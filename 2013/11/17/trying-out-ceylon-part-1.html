<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Trying out Ceylon - Part 1</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

        <!-- zoomingbox -->
        <script src="/assets/js/jquery-1.11.0.min.js"></script>
        <script src="/assets/js/jquery.zoomingbox.min.js"></script>
        <link href="/assets/css/zoomingbox.min.css" rel="stylesheet" />
    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">vigoo's software development blog</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Trying out Ceylon - Part 1</h2>
<p class="meta">17 Nov 2013</p>

<div class="post">
<p>Ceylon&#39;s first production release was announced on 12th of November. I decided to try it out after going through the quick introduction, as it looked quite promising. In a series of posts I&#39;d like to share my first attempts to use this interesting language.</p>

<p>This first release came with an eclipse plugin as well - after installing it I was immediately able to start working on my test project. In this few hours the plugin seemed to be stable enough, I did not experience any problems.</p>

<p>I have a <code>JVLT</code> file which I created while attending a foreign language course about a year ago. I was using only a limited subset of this application, so basically what I have is a .jvlt file, which is in fact a ZIP archive, in which a <code>dict.xml</code> stores a set of words and for each word one or more translation and the lesson we have learnt it.</p>

<p>See the following example:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dictionary</span> <span class="na">language=</span><span class="s">&quot;french&quot;</span> <span class="na">version=</span><span class="s">&quot;1.4&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;entry</span> <span class="na">id=</span><span class="s">&quot;e275&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;orth&gt;</span>à côté de<span class="nt">&lt;/orth&gt;</span>
    <span class="nt">&lt;sense</span> <span class="na">id=</span><span class="s">&quot;e275-s1&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;trans&gt;</span>mellett<span class="nt">&lt;/trans&gt;</span>
    <span class="nt">&lt;/sense&gt;</span>
    <span class="nt">&lt;sense</span> <span class="na">id=</span><span class="s">&quot;e275-s2&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;trans&gt;</span>mellé<span class="nt">&lt;/trans&gt;</span>
    <span class="nt">&lt;/sense&gt;</span>
    <span class="nt">&lt;lesson&gt;</span>8<span class="nt">&lt;/lesson&gt;</span>
  <span class="nt">&lt;/entry&gt;</span>
<span class="nt">&lt;/dictionary&gt;</span></code></pre></div>
 

<p>My idea was to write an application that helps me learning and practicing these words.</p>

<p>In this first post I&#39;m going to load the dictionary from the JVLT file.</p>

<p>To get started, I created a new Ceylon module with the help of the IDE called jvlt. This immediately created three program units: <code>module.ceylon</code>, <code>package.ceylon</code> and <code>run.ceylon</code>. The <code>module.ceylon</code> contains the module definition, which also describes the module&#39;s dependencies. As I was trying to implement the dictionary reader, I ended up with the following module definition:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="n">module</span> <span class="n">jvlt</span> <span class="s">&quot;1.0.0&quot;</span> <span class="o">{</span>
    <span class="nd">shared</span> <span class="kn">import</span> <span class="nn">ceylon.file</span> <span class="s">&quot;1.0.0&quot;</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">ceylon.collection</span> <span class="s">&quot;1.0.0&quot;</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">ceylon.interop.java</span> <span class="s">&quot;1.0.0&quot;</span><span class="o">;</span>
 
    <span class="kn">import</span> <span class="nn">javax.xml</span> <span class="s">&quot;7&quot;</span><span class="o">;</span> 
 
    <span class="kn">import</span> <span class="nn">ceylon.test</span> <span class="s">&quot;1.0.0&quot;</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>
 

<p>Let&#39;s start with the data model we want to build up! The dictionary consists of words:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="s">&quot;Represents a foreign word with one or more senses&quot;</span>
<span class="nd">shared</span> <span class="kd">class</span> <span class="nf">Word</span><span class="o">(</span><span class="nd">shared</span> <span class="n">String</span> <span class="n">word</span><span class="o">,</span> <span class="nd">shared</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">senses</span><span class="o">,</span> <span class="nd">shared</span> <span class="n">Integer</span> <span class="n">lesson</span><span class="o">){</span> 
<span class="o">}</span></code></pre></div>
 

<p>The word, senses and lessons are all shared attributes of this class, accessible from the outside. To make it easy to access the word objects by their foreign word, I&#39;m currently storing them in a map:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="s">&quot;Represents a dictionary of words in a given language&quot;</span>
<span class="nd">shared</span> <span class="kd">class</span> <span class="nf">Dictionary</span><span class="o">(</span><span class="nd">shared</span> <span class="n">String</span> <span class="n">language</span><span class="o">,</span> <span class="nd">shared</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">word</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="o">&gt;</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
<span class="o">}</span></code></pre></div>
 

<p>Basically that&#39;s the data model, but I wrapped the whole thing in an abstract JVLT class which looks like this:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="s">&quot;Represents a JVLT file&quot;</span>
<span class="nd">abstract</span> <span class="nd">shared</span> <span class="kd">class</span> <span class="nf">JVLT</span><span class="o">()</span> <span class="o">{</span>
 
    <span class="s">&quot;The dictionary stored in this JVLT&quot;</span>
    <span class="nd">formal</span> <span class="nd">shared</span> <span class="n">Dictionary</span> <span class="n">dictionary</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>
 

<p>The idea is that you get a JVLT instance from one of the helper functions and then use it as a root of the data model.</p>

<p>The next thing is to create this data model from the JVLT files. For this, I needed two things:</p>

<ul>
<li>Reading a ZIP archive</li>
<li>Parsing XML</li>
</ul>

<p>It turned out that Ceylon&#39;s file module has ZIP support, with the <code>createZipFileSystem</code> function as an entry point. I made two module-level functions beside the JVLT class for creating instances deriving from the abstract JVLT class:</p>

<ul>
<li><code>loadJVLT</code> which loads a JVLT ZIP archive from the file system</li>
<li><code>loadJVLTFromDictionaryString</code> oads directly a dict.xml-like XML passed as a simple string. I&#39;m using this for unit testing the XML parser.</li>
</ul>

<p>Let&#39;s see the ZIP handling first:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="s">&quot;Loads a JVLT file from a `.jvlt` ZIP archive, if possible.&quot;</span>
<span class="nd">shared</span> <span class="n">JVLT</span><span class="o">?</span> <span class="n">loadJVLT</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">value</span> <span class="n">zip</span> <span class="o">=</span> <span class="n">createZipFileSystem</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
    <span class="kt">value</span> <span class="n">dictPath</span> <span class="o">=</span> <span class="n">zip</span><span class="o">.</span><span class="na">parsePath</span><span class="o">(</span><span class="s">&quot;/dict.xml&quot;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">is</span> <span class="n">File</span> <span class="n">dictFile</span> <span class="o">=</span> <span class="n">dictPath</span><span class="o">.</span><span class="na">resource</span><span class="o">)</span> <span class="o">{</span>  
        <span class="k">try</span> <span class="o">(</span><span class="n">reader</span> <span class="o">=</span> <span class="n">dictFile</span><span class="o">.</span><span class="n">Reader</span><span class="o">())</span> <span class="o">{</span>
   
            <span class="k">return</span> <span class="nf">loadJVLTFromDictionaryString</span><span class="o">(</span><span class="n">readAll</span><span class="o">(</span><span class="n">reader</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
 

<p>Well, the error handling is not too sophisticated in this case, it either returns a JVLT or returns <code>null</code> if the given file did not have a <code>dict.xml</code> in it. Other error conditions such as a <code>dict.xml</code> with a wrong format, etc., are not handled currently. As you can see, I&#39;m reusing my other load function here, once the <code>dict.xml</code> is read.</p>

<p>There are two interesting things here. First, the if statement where we check if the resource is an instance of <code>File</code> and immediately store it in the value called <code>dictFile</code>. The <code>dictPath.resource</code> attribute has the type <code>Resource</code> which is a Ceylon interface. It is either an <code>ExistingResource</code>: <code>Directory</code>, <code>File</code> or <code>Link</code>, or <code>Nil</code>. In any case if it is not a <code>File</code> instance, we just return <code>null</code>.</p>

<p>For simplicity, I&#39;m reading the full <code>dict.xml</code> into a string before parsing it. For this purpose I wrote a small helper function <code>readAll</code>:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="s">&quot;Reads all lines from a file reader and returns the concatenated string&quot;</span>
<span class="n">String</span> <span class="nf">readAll</span><span class="o">(</span><span class="n">File</span><span class="o">.</span><span class="n">Reader</span> <span class="n">reader</span><span class="o">)</span> <span class="o">{</span> 
    <span class="nd">variable</span> <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
 
    <span class="k">while</span> <span class="o">(</span><span class="k">exists</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">line</span><span class="o">;</span> 
    <span class="o">}</span>
 
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>
 

<p>Probably it&#39;s not an optimal solution, but works :)</p>

<p>Now that we have our data model and have a way to build it up from XML, we can write some unit tests to see how it works. The Ceylon SDK has a test module and the Ceylon IDE supports running the tests. There is a <a href="http://ceylon-lang.org/documentation/1.0/ide/test-plugin/">separate page in the documentation</a> describing how. It is really simple, I had to add the test module as a dependency, and I created a separate file to hold my test definitions. The class groups the tests together and optionally supports running extra code before/after each test case, as in other test frameworks:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="kd">class</span> <span class="nf">DictionaryParserTests</span><span class="o">()</span> <span class="o">{</span>

    <span class="nd">shared</span> <span class="n">test</span> <span class="kt">void</span> <span class="nf">emptyDictionary</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">value</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">loadJVLTFromDictionaryString</span><span class="o">(</span><span class="s">&quot;&lt;dictionary&gt;&quot;</span><span class="o">);</span>
      
        <span class="k">assert</span> <span class="o">(</span><span class="n">dic</span><span class="o">.</span><span class="na">dictionary</span><span class="o">.</span><span class="na">words</span><span class="o">.</span><span class="na">empty</span><span class="o">);</span>
        <span class="k">assert</span> <span class="o">(</span><span class="n">dic</span><span class="o">.</span><span class="na">dictionary</span><span class="o">.</span><span class="na">language</span> <span class="o">==</span> <span class="s">&quot;unknown&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">shared</span> <span class="n">test</span> <span class="kt">void</span> <span class="nf">languageAttributeRead</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">value</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">loadJVLTFromDictionaryString</span><span class="o">(</span><span class="s">&quot;&lt;dictionary language=&quot;</span><span class="n">testlang</span><span class="s">&quot;&gt;&quot;</span><span class="o">);</span>
        <span class="k">assert</span> <span class="o">(</span><span class="n">dic</span><span class="o">.</span><span class="na">dictionary</span><span class="o">.</span><span class="na">language</span> <span class="o">==</span> <span class="s">&quot;testlang&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ...</span></code></pre></div>
 

<p>I won&#39;t paste here all the test code, only a few samples to get the feeling how the Ceylon code looks like. To test whether a given word&#39;s translations are loaded correctly, I wrote a helper function:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="kt">void</span> <span class="nf">assertSenses</span><span class="o">(</span><span class="n">JVLT</span> <span class="n">jvlt</span><span class="o">,</span> <span class="n">String</span> <span class="n">w</span><span class="o">,</span> <span class="o">[</span><span class="n">String</span><span class="o">+]</span> <span class="n">expectedSenses</span><span class="o">)</span> <span class="o">{</span>
  
    <span class="n">Word</span><span class="o">?</span> <span class="n">word</span> <span class="o">=</span> <span class="n">jvlt</span><span class="o">.</span><span class="na">dictionary</span><span class="o">.</span><span class="na">words</span><span class="o">[</span><span class="n">w</span><span class="o">];</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">exists</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">assert</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">senses</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">HashSet</span><span class="o">(</span><span class="n">expectedSenses</span><span class="o">)));</span>  
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">fail</span><span class="o">(</span><span class="s">&quot;Word does not exists&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
 

<p>This helper function can be used to assert that a word has been loaded correctly:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="nd">shared</span> <span class="n">test</span> <span class="kt">void</span> <span class="nf">wordWithMultipleSenses</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">value</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">loadJVLTFromDictionaryString</span><span class="o">(</span>
        <span class="s">&quot;&lt;dictionary&gt;</span>
<span class="s">            &lt;entry id=&quot;</span><span class="n">e1</span><span class="s">&quot;&gt;</span>
<span class="s">                &lt;orth&gt;src1&lt;/orth&gt;</span>
<span class="s">                &lt;sense id=&quot;</span><span class="n">e1</span><span class="o">-</span><span class="n">s1</span><span class="s">&quot;&gt;</span>
<span class="s">                    &lt;trans&gt;dst1&lt;/trans&gt;</span>
<span class="s">                &lt;/sense&gt;</span>
<span class="s">                &lt;sense id=&quot;</span><span class="n">e1</span><span class="o">-</span><span class="n">s2</span><span class="s">&quot;&gt;</span>
<span class="s">                    &lt;trans&gt;dst2&lt;/trans&gt;</span>
<span class="s">                &lt;/sense&gt;    </span>
<span class="s">            &lt;/entry&gt;  </span>
<span class="s">        &lt;/dictionary&gt;&quot;</span><span class="o">);</span>
 
    <span class="n">assertSenses</span><span class="o">(</span><span class="n">dic</span><span class="o">,</span> <span class="s">&quot;src1&quot;</span><span class="o">,</span> <span class="o">[</span><span class="s">&quot;dst1&quot;</span><span class="o">,</span> <span class="s">&quot;dst2&quot;</span><span class="o">]);</span>
<span class="o">}</span></code></pre></div>
 

<p>Now the only problem is that there is no XML parsing support in the Ceylon SDK currently, so it has to be done using Java interop. As I wrote the code to build up the data model from the XML, I wrote several helper functions to make it easier to fit into the language. So let&#39;s see first how the dictionary loading is defined, and then I&#39;ll show the helper functions.</p>

<p>The XML parsing is done by two module level functions which are not shared - only used by the JVLT constructor functions I shown before. The first one creates a map entry for a single word:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="s">&quot;Creates a word entry for the dictionary&quot;</span>
<span class="n">String</span><span class="o">-&gt;</span><span class="n">Word</span> <span class="n">loadEntry</span><span class="o">(</span><span class="n">Element</span> <span class="n">elem</span><span class="o">)</span> <span class="o">{</span>
 
    <span class="kt">value</span> <span class="n">w</span> <span class="o">=</span> <span class="n">Word</span> <span class="o">{</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">selectNodeText</span><span class="o">(</span><span class="n">elem</span><span class="o">,</span> <span class="s">&quot;orth&quot;</span><span class="o">)</span> <span class="k">else</span> <span class="s">&quot;???&quot;</span><span class="o">;</span>
        <span class="n">lesson</span> <span class="o">=</span> <span class="n">selectNodeInteger</span><span class="o">(</span><span class="n">elem</span><span class="o">,</span> <span class="s">&quot;lesson&quot;</span><span class="o">)</span> <span class="k">else</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">senses</span> <span class="o">=</span> <span class="n">HashSet</span><span class="o">(</span><span class="n">selectNodes</span><span class="o">(</span><span class="n">elem</span><span class="o">,</span> <span class="s">&quot;sense/trans&quot;</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">map</span><span class="o">((</span><span class="n">Node</span> <span class="n">n</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">n</span><span class="o">.</span><span class="na">textContent</span><span class="o">));</span>
    <span class="o">};</span>
    <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="na">word</span><span class="o">-&gt;</span><span class="n">w</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>
 

<p>and the second one loads all the words from the XML document:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="s">&quot;Loads a dictionary from JVLT&#39;s `dict.xml` format.&quot;</span>
<span class="n">Dictionary</span> <span class="nf">loadDictionaryFromXML</span><span class="o">(</span><span class="n">Document</span> <span class="nd">doc</span><span class="o">)</span> <span class="o">{</span> 

    <span class="nd">doc</span><span class="o">.</span><span class="na">documentElement</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">Dictionary</span> <span class="o">{</span> 
        <span class="n">language</span> <span class="o">=</span> <span class="n">getAttribute</span><span class="o">(</span><span class="nd">doc</span><span class="o">.</span><span class="na">documentElement</span><span class="o">,</span> <span class="s">&quot;language&quot;</span><span class="o">)</span> <span class="k">else</span> <span class="s">&quot;unknown&quot;</span><span class="o">;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">HashMap</span><span class="o">({</span> 
            <span class="k">for</span> <span class="o">(</span><span class="n">node</span> <span class="k">in</span> <span class="n">selectNodes</span><span class="o">(</span><span class="nd">doc</span><span class="o">,</span> <span class="s">&quot;dictionary/entry&quot;</span><span class="o">))</span>
                <span class="k">if</span> <span class="o">(</span><span class="k">is</span> <span class="n">Element</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">node</span><span class="o">)</span>
                    <span class="n">loadEntry</span><span class="o">(</span><span class="n">elem</span><span class="o">)</span> <span class="o">});</span>   
    <span class="o">};</span>
<span class="o">}</span></code></pre></div>
 

<p>The function which returns the JVLT instance uses this function and Java interop to read the dictionary:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="s">&quot;Loads a JVLT file by the parsing the dictionary XML directly from a string&quot;</span>
<span class="nd">shared</span> <span class="n">JVLT</span> <span class="nf">loadJVLTFromDictionaryString</span><span class="o">(</span><span class="n">String</span> <span class="n">dictXML</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">value</span> <span class="nd">doc</span><span class="n">BuilderFactory</span> <span class="o">=</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="kt">value</span> <span class="n">builder</span> <span class="o">=</span> <span class="nd">doc</span><span class="n">BuilderFactory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
    <span class="kt">value</span> <span class="nd">doc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">javaString</span><span class="o">(</span><span class="n">dictXML</span><span class="o">).</span><span class="na">bytes</span><span class="o">));</span>
 
    <span class="kd">object</span> <span class="nc">result</span> <span class="kd">extends</span> <span class="nf">JVLT</span><span class="o">()</span> <span class="o">{</span> 
        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">loadDictionaryFromXML</span><span class="o">(</span><span class="nd">doc</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>
 

<p>There are two things to notice here: we had to convert from Ceylon&#39;s string to Java string. This is not done automatically and we need the <code>ceylon.interop.java</code> module to do it. In the last lines we define an anonymous class extending from JVLT and overwriting it&#39;s abstract dictionary attribute. Then this anonymous class instance is returned as the loaded JVLT.</p>

<p>To make the XML parsing less painful, I defined a few helper functions in a separate compilation unit (<code>XmlHelper.ceylon</code>). I won&#39;t show here the full file but there are some interesting parts. First, from Ceylon you cannot call static methods, but you can import them. I&#39;m using the following two import statements: </p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="kn">import</span> <span class="nn">org.w3c.dom</span> <span class="o">{</span> <span class="n">Node</span><span class="o">,</span> <span class="n">NodeList</span><span class="o">,</span> <span class="n">Element</span> <span class="o">}</span>
<span class="kn">import</span> <span class="nn">javax.xml.xpath</span> <span class="o">{</span> <span class="n">XPathFactory</span> <span class="o">{</span> <span class="n">newXPathFactory</span> <span class="o">=</span> <span class="n">newInstance</span> <span class="o">},</span>
       <span class="n">XPathConstants</span> <span class="o">{</span> <span class="n">nodeSet</span> <span class="o">=</span> <span class="err">\</span><span class="n">iNODESET</span> <span class="o">}}</span></code></pre></div>
 

<p>The first one is straightforward. It imports three DOM interfaces. The second one first imports the <code>XPathFactory.newInstance</code> static method and also renames it, as newInstance is a too generic name without its class name as a prefix. The third line imports a constant value and gives it a Ceylon-compatible name. Because in Ceylon only the types can start with an uppercase character, we have to use a special and ugly syntax which helps the interoperability - prefixing it with <code>\i</code>.</p>

<p>The <code>ceylon.interop.java</code> module has helper classes to make Java Iterable objects iterable in Ceylon, but unfortunately the <code>NodeList</code> interface is not iterable in Java either. So I wrote a simple wrapper that iterates through a node list:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="kd">class</span> <span class="nf">NodeListIterator</span><span class="o">(</span><span class="n">NodeList</span> <span class="n">nodes</span><span class="o">)</span> <span class="kd">satisfies</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">shared</span> <span class="nd">actual</span> <span class="k">default</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">iterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">object</span> <span class="nc">it</span> <span class="kd">satisfies</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="o">{</span>   
            <span class="nd">variable</span> <span class="n">Integer</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
   
            <span class="nd">shared</span> <span class="nd">actual</span> <span class="n">Node</span><span class="o">|</span><span class="n">Finished</span> <span class="n">next</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">++);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">finished</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">it</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
 

<p>Using this iterator and the imports I wrote a <code>selectNodes</code> function to run XPath expressions and return the result as a Ceylon iterable:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="o">{</span><span class="n">Node</span><span class="o">*}</span> <span class="n">selectNodes</span><span class="o">(</span><span class="n">Node</span> <span class="n">root</span><span class="o">,</span> <span class="n">String</span> <span class="n">xpath</span><span class="o">)</span> <span class="o">{</span> 
    <span class="kt">value</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">newXPathFactory</span><span class="o">();</span>
    <span class="kt">value</span> <span class="n">xpathCompiler</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newXPath</span><span class="o">();</span>
    <span class="kt">value</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">xpathCompiler</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">xpath</span><span class="o">);</span>
    <span class="kt">value</span> <span class="n">nodeList</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">nodeSet</span><span class="o">);</span> 
    <span class="k">if</span> <span class="o">(</span><span class="k">is</span> <span class="n">NodeList</span> <span class="n">nodeList</span><span class="o">)</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="nf">NodeListIterator</span><span class="o">(</span><span class="n">nodeList</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">[];</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
 

<p>Using this function it is very easy to write a variant that selects a single node:</p>

<div class="highlight"><pre><code class="language-ceylon" data-lang="ceylon"><span class="n">Node</span><span class="o">?</span> <span class="n">selectNode</span><span class="o">(</span><span class="n">Node</span> <span class="n">root</span><span class="o">,</span> <span class="n">String</span> <span class="n">xpath</span><span class="o">)</span> <span class="o">{</span> 
    <span class="k">return</span> <span class="nf">selectNodes</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpath</span><span class="o">).</span><span class="na">first</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>
 

<p>There are some other helper functions returning the node&#39;s text, converting it to integer, etc. but I think they are not that interesting. Now that I have my data model which is built from my JVLT file, the next thing is to make a user interface somehow where the vocabulary can be shown an the user&#39;s knowledge can be tested/improved. This will be the topic of some future posts, as soon as I have time to experiment more with this new language.</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vigoo'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    


          <div class="footer">
            <div class="contact">
              <p>
                Daniel Vigovszky<br />
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/vigoo">github.com/vigoo</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
    <script type="text/javascript">
      $('.zimg').zoomingBox();
    </script>
</html>
