<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Writing kubectl plugins with ZIO K8s</title>
        
        <link rel="alternate" type="application/atom+xml" title="vigoo's software development blog" href="./atom.xml" />
        
        <link rel="stylesheet" type="text/css" href="../css/haskell.org.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
        
        <!-- zoomingbox -->
        <script src="../js/jquery-1.11.0.min.js"></script>
        <script src="../js/jquery.zoomingbox.min.js"></script>
        <link href="../css/zoomingbox.min.css" rel="stylesheet" />
    </head>
    <body>
        <div id="header">
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Writing kubectl plugins with ZIO K8s</h1>

            <div class="info">
    Posted on March  7, 2021
    
</div>

<p>Originally posted <a href="https://ziverge.com/blog/zio-k8s-kubectl-plugin">at the Ziverge blog</a>.</p>
<p>Andrea Peruffo recently published <a href="https://www.lightbend.com/blog/writing-kubectl-plugins-with-scala-or-java-with-fabric8-kubernetes-client-on-graalvm?utm_campaign=Oktopost-BLG+-+Writing+Kubectl+plugins+in+Java+or+Scala">a blog post on the Lightbend blog</a> about how they migrated a <code>kubectl</code> plugin from Golang to Scala using the <a href="https://github.com/fabric8io/kubernetes-client">Fabric8</a> Kubernetes client and a few Scala libraries. This is a perfect use case for the <a href="https://coralogix.github.io/zio-k8s/">zio-k8s library</a> announced <a href="https://coralogix.com/log-analytics-blog/the-coralogix-operator-a-tale-of-zio-and-kubernetes/">two weeks ago</a>, so we decided to write this post demonstrating how to implement the same example using the ZIO ecosystem.</p>
<p>We are going to implement the same example, originally described in the <a href="https://dev.to/ikwattro/write-a-kubectl-plugin-in-java-with-jbang-and-fabric8-566">Write a kubectl plugin in Java with JBang and fabric8</a> article, using the following libraries:</p>
<ul>
<li><a href="https://zio.dev/">ZIO</a></li>
<li><a href="https://coralogix.github.io/zio-k8s/">ZIO K8s</a></li>
<li><a href="https://zio.github.io/zio-logging/">ZIO Logging</a></li>
<li><a href="https://vigoo.github.io/clipp/docs/">clipp</a></li>
<li><a href="https://sttp.softwaremill.com/en/latest/">sttp</a></li>
<li><a href="https://circe.github.io/circe/">circe</a></li>
</ul>
<p>The source code of the example <a href="https://github.com/zivergetech/zio-k8s-kubectl-plugin-example">can be found here</a>.</p>
<p>The linked blog post does a great job in explaining the benefits and difficulties of compiling to native image with GraalVM so we are not going to repeat it here. Instead, we will focus on how the implementation looks in the functional Scala world.</p>
<p>The example has to implement two <em>kubectl commands</em>: <code>version</code> to print its own version and <code>list</code> to list information about <em>all Pods of the Kubernetes cluster</em> in either ASCII table, JSON or YAML format.</p>
<h3 id="cli-parameters">CLI parameters</h3>
<p>Let’s start with defining these command line options with the <a href="https://vigoo.github.io/clipp/docs/">clipp</a> library!</p>
<p>First, we define the data structures that describe our parameters:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> <span class="ex">Format</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Format</span> <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="kw">object</span> Default <span class="kw">extends</span> <span class="ex">Format</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="kw">object</span> Json <span class="kw">extends</span> <span class="ex">Format</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="kw">object</span> Yaml <span class="kw">extends</span> <span class="ex">Format</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Command</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Command <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">ListPods</span><span class="op">(</span>format<span class="op">:</span> <span class="ex">Format</span><span class="op">)</span> <span class="kw">extends</span> Command</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="kw">object</span> Version <span class="kw">extends</span> Command</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Parameters</span><span class="op">(</span>verbose<span class="op">:</span> <span class="ex">Boolean</span><span class="op">,</span> command<span class="op">:</span> Command<span class="op">)</span></span></code></pre></div>
<p>When parsing the arguments (passed as an array of strings), we need to either produce a <code>Parameters</code> value or fail and print some usage information.</p>
<p>With <code>clipp</code>, this is done by defining a parameter parser using its parser DSL in a <em>for comprehension</em>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> spec <span class="op">=</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    _           <span class="op">&lt;-</span> <span class="fu">metadata</span><span class="op">(</span><span class="st">&quot;kubectl lp&quot;</span><span class="op">)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    verbose     <span class="op">&lt;-</span> <span class="fu">flag</span><span class="op">(</span><span class="st">&quot;Verbose logging&quot;</span><span class="op">,</span> <span class="ch">'v'</span><span class="op">,</span> <span class="st">&quot;verbose&quot;</span><span class="op">)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    commandName <span class="op">&lt;-</span> <span class="fu">command</span><span class="op">(</span><span class="st">&quot;version&quot;</span><span class="op">,</span> <span class="st">&quot;list&quot;</span><span class="op">)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    command     <span class="op">&lt;-</span> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      commandName <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;version&quot;</span> <span class="op">=&gt;</span> </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pure</span><span class="op">(</span>Command<span class="op">.</span>Version<span class="op">)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;list&quot;</span>    <span class="op">=&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            specifiedFormat <span class="op">&lt;-</span> optional <span class="op">{</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                                namedParameter<span class="op">[</span><span class="ex">Format</span><span class="op">](</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;Output format&quot;</span><span class="op">,</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;default|json|yaml&quot;</span><span class="op">,</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                                  <span class="ch">'o'</span><span class="op">,</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;output&quot;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                                <span class="op">)</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                              <span class="op">}</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>            format           <span class="op">=</span> specifiedFormat<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span><span class="ex">Format</span><span class="op">.</span>Default<span class="op">)</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span> <span class="cf">yield</span> Command<span class="op">.</span><span class="fu">ListPods</span><span class="op">(</span>format<span class="op">)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="fu">Parameters</span><span class="op">(</span>verbose<span class="op">,</span> command<span class="op">)</span></span></code></pre></div>
<p>As we can see, it is possible to make decisions in the parser based on the previously parsed values, so each <em>command</em> can have a different set of arguments. In order to parse the possible <em>output formats</em>, we also implement the <code>ParameterParser</code> type class for <code>Format</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">val</span> parameterParser<span class="op">:</span> ParameterParser<span class="op">[</span><span class="ex">Format</span><span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> ParameterParser<span class="op">[</span><span class="ex">Format</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">def</span> <span class="fu">parse</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="ex">Format</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>      value<span class="op">.</span>toLowerCase <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;default&quot;</span> <span class="op">=&gt;</span> <span class="fu">Right</span><span class="op">(</span><span class="ex">Format</span><span class="op">.</span>Default<span class="op">)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;json&quot;</span>    <span class="op">=&gt;</span> <span class="fu">Right</span><span class="op">(</span><span class="ex">Format</span><span class="op">.</span>Json<span class="op">)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;yaml&quot;</span>    <span class="op">=&gt;</span> <span class="fu">Right</span><span class="op">(</span><span class="ex">Format</span><span class="op">.</span>Yaml<span class="op">)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> _         <span class="op">=&gt;</span> <span class="fu">Left</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Invalid output format '</span><span class="ss">$value</span><span class="st">', use 'default', 'json' or 'yaml'</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">def</span> example<span class="op">:</span> <span class="ex">Format</span> <span class="op">=</span> <span class="ex">Format</span><span class="op">.</span>Default</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>This is all we need to bootstrap our command line application. The following main function parses the arguments and provides the parsed <code>Parameters</code> value to the <code>ZIO</code> program:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">run</span><span class="op">(</span>args<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> URIO<span class="op">[</span>zio<span class="op">.</span>ZEnv<span class="op">,</span> ExitCode<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> clippConfig <span class="op">=</span> config<span class="op">.</span><span class="fu">fromArgsWithUsageInfo</span><span class="op">(</span>args<span class="op">,</span> Parameters<span class="op">.</span>spec<span class="op">)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runWithParameters</span><span class="op">()</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">provideCustomLayer</span><span class="op">(</span>clippConfig<span class="op">)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>catchAll <span class="op">{</span> _<span class="op">:</span> ParserFailure <span class="op">=&gt;</span> ZIO<span class="op">.</span><span class="fu">succeed</span><span class="op">(</span>ExitCode<span class="op">.</span>failure<span class="op">)</span> <span class="op">}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">runWithParameters</span><span class="op">():</span> ZIO<span class="op">[</span>ZEnv <span class="kw">with</span> ClippConfig<span class="op">[</span>Parameters<span class="op">],</span> Nothing<span class="op">,</span> ExitCode<span class="op">]</span> <span class="op">=</span> <span class="co">// ...</span></span></code></pre></div>
<h3 id="working-with-kubernetes">Working with Kubernetes</h3>
<p>In <code>runWithParameters</code>, we have everything needed to initialize the logging and Kubernetes modules and perform the actual command. Before talking about the initialization though, let’s take a look at how we can list the pods!</p>
<p>We define a data type holding all the information we want to report about each pod:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">PodInfo</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> namespace<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> status<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> message<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
<p>The task now is to fetch <em>all pods</em> from Kubernetes and construct <code>PodInfo</code> values. In <code>zio-k8s</code> <em>getting a list of pods</em> is defined as a <strong>ZIO Stream</strong>, which under the hood sends multiple HTTP requests to Kubernetes taking advantage of its <em>pagination</em> capability. In this <em>stream</em> each element will be a <code>Pod</code> and we can start processing them one by one as soon they arrive over the wire. This way the implementation of the <code>list</code> command can be something like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">run</span><span class="op">(</span>format<span class="op">:</span> <span class="ex">Format</span><span class="op">)</span> <span class="op">=</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">&lt;-</span> log<span class="op">.</span><span class="fu">debug</span><span class="op">(</span><span class="st">&quot;Executing the list command&quot;</span><span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">&lt;-</span> pods</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">getAll</span><span class="op">(</span>namespace <span class="op">=</span> <span class="bu">None</span><span class="op">)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">mapM</span><span class="op">(</span>toModel<span class="op">)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">run</span><span class="op">(</span>reports<span class="op">.</span><span class="fu">sink</span><span class="op">(</span>format<span class="op">))</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>catchAll <span class="op">{</span> k8sFailure <span class="op">=&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>              console<span class="op">.</span><span class="fu">putStrLnErr</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Failed to get the list of pods: </span><span class="ss">$k8sFailure&quot;</span><span class="op">)</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="op">()</span></span></code></pre></div>
<p>Let’s take a look at each line!</p>
<p>First, <code>log.debug</code> uses the <em>ZIO logging</em> library. We are going to initialize logging in a way that these messages only appear if the <code>--verbose</code> option was enabled.</p>
<p>Then <code>pods.getAll</code> is the ZIO Stream provided by the <em>ZIO K8s</em> library. Not providing a specific namespace means that we are getting pods from <em>all</em> namespaces.</p>
<p>With <code>mapM(toModel)</code> we transform each <code>Pod</code> in the stream to our <code>PodInfo</code> data structure.</p>
<p>Finally we <code>run</code> the stream into a <em>sink</em> that is responsible for displaying the <code>PodInfo</code> structures with the specific <em>output format</em>.</p>
<p>The <code>Pod</code> objects returned in the stream are simple <em>case classes</em> containing all the information available for the given resource. Most of the fields of these case classes are <em>optional</em> though, even though we can be sure that in our case each pod would have a name, a namespace and a status. To make working with these data structures easier within a set of expectations, they feature <em>getter methods</em> that are ZIO functions either returning the field’s value, or failing if they are not specified. With these we can implement <code>toModel</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">toModel</span><span class="op">(</span>pod<span class="op">:</span> Pod<span class="op">):</span> IO<span class="op">[</span>K8sFailure<span class="op">,</span> PodInfo<span class="op">]</span> <span class="op">=</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>      metadata  <span class="op">&lt;-</span> pod<span class="op">.</span>getMetadata</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      name      <span class="op">&lt;-</span> metadata<span class="op">.</span>getName</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      namespace <span class="op">&lt;-</span> metadata<span class="op">.</span>getNamespace</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      status    <span class="op">&lt;-</span> pod<span class="op">.</span>getStatus</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      phase     <span class="op">&lt;-</span> status<span class="op">.</span>getPhase</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      message    <span class="op">=</span> status<span class="op">.</span>message<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">yield</span> <span class="fu">PodInfo</span><span class="op">(</span>name<span class="op">,</span> namespace<span class="op">,</span> phase<span class="op">,</span> message<span class="op">)</span></span></code></pre></div>
<p>An alternative would be to just store the optional values in <code>PodInfo</code> and handle their absence in the <em>report sink</em>.</p>
<p>Let’s talk about the <em>type</em> of the above defined <code>run</code> function:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ZIO<span class="op">[</span>Pods <span class="kw">with</span> <span class="ex">Console</span> <span class="kw">with</span> Logging<span class="op">,</span> Nothing<span class="op">,</span> <span class="bu">Unit</span><span class="op">]</span></span></code></pre></div>
<p>The ZIO <em>environment</em> precisely specifies the modules used by our <code>run</code> function:</p>
<table>
<colgroup>
<col style="width: 13%" />
<col style="width: 86%" />
</colgroup>
<thead>
<tr class="header">
<th>Module</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Pods</code></td>
<td>for accessing K8s pods</td>
</tr>
<tr class="even">
<td><code>Console</code></td>
<td>for printing <em>errors</em> on the standard error channel with <code>putStrLnErr</code></td>
</tr>
<tr class="odd">
<td><code>Logging</code></td>
<td>for emitting some debug logs</td>
</tr>
</tbody>
</table>
<p>The error type is <code>Nothing</code> because it can never fail - all errors are catched and displayed for the user within the run function.</p>
<h3 id="initialization">Initialization</h3>
<p>Now we can see that in order to run the <code>list</code> command in <code>runWithParameters</code>, we must <em>provide</em> <code>Pods</code> and <code>Logging</code> modules to our implementation (<code>Console</code> is part of the default environment and does not need to be provided).</p>
<p>These modules are described by <em>ZIO Layers</em> which can be composed together to provide the <em>environment</em> for running our ZIO program. In this case we need to define a <em>logging layer</em> and a <em>kubernetes pods client</em> layer and then compose the two for our <code>list</code> implementation.</p>
<p>Let’s start with logging:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">configuredLogging</span><span class="op">(</span>verbose<span class="op">:</span> <span class="ex">Boolean</span><span class="op">):</span> ZLayer<span class="op">[</span><span class="ex">Console</span> <span class="kw">with</span> Clock<span class="op">,</span> Nothing<span class="op">,</span> Logging<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> logLevel <span class="op">=</span> <span class="cf">if</span> <span class="op">(</span>verbose<span class="op">)</span> LogLevel<span class="op">.</span>Trace <span class="cf">else</span> LogLevel<span class="op">.</span>Info</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    Logging<span class="op">.</span><span class="fu">consoleErr</span><span class="op">(</span>logLevel<span class="op">)</span> <span class="op">&gt;&gt;&gt;</span> initializeSlf4jBridge</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>We create a simple ZIO console logger that will print lines to the standard error channel; the enabled log level is determined by the <code>verbose</code> command line argument. As this logger writes to the console and also prints timestamps, our logging layer <em>requires</em> <code>Console with Clock</code> to be able to build a <code>Logging</code> module. Enabling the <em>SLF4j bridge</em> guarantees that logs coming from third party libraries will also get logged through ZIO logging. In our example this means that when we enable verbose logging, our <code>kubectl</code> plugin will log the HTTP requests made by the Kubernetes library!</p>
<p>The second layer we must define constructs a <code>Pods</code> module:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> pods <span class="op">=</span> k8sDefault <span class="op">&gt;&gt;&gt;</span> Pods<span class="op">.</span>live<span class="op">)</span></span></code></pre></div>
<p>By using <code>k8sDefault</code> we ask <code>zio-k8s</code> to use the <em>default configuration chain</em>, which first tries to load the <code>kubeconfig</code> and use the active <em>context</em> stored in it. This is exactly what <code>kubectl</code> does, so it is the perfect choice when writing a <code>kubectl</code> plugin. Other variants provide more flexibility such as loading custom configuration with the <a href="https://zio.github.io/zio-config/">ZIO Config</a> library. Once we have a <em>k8s configuration</em> we just feed it to the set of resource modules we need. In this example we only need to access pods. In more complex applications this would be something like <code>k8sDefault &gt;&gt;&gt; (Pods.live ++ Deployments.live ++ ...)</code>.</p>
<p>With both layers defined, we can now provide them to our command implementation:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">runCommand</span><span class="op">(</span>parameters<span class="op">.</span>command<span class="op">)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">provideCustomLayer</span><span class="op">(</span>logging <span class="op">++</span> pods<span class="op">)</span></span></code></pre></div>
<h3 id="output">Output</h3>
<p>The last thing missing is the <em>report sink</em> that we are running the stream of pods into. We are going to define three different sinks for the three output types.</p>
<p>Let’s start with JSON!</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sink<span class="op">[</span>T<span class="op">:</span> <span class="ex">Encoder</span><span class="op">]:</span> ZSink<span class="op">[</span><span class="ex">Console</span><span class="op">,</span> Nothing<span class="op">,</span> T<span class="op">,</span> T<span class="op">,</span> <span class="bu">Unit</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  ZSink<span class="op">.</span>foreach <span class="op">{</span> <span class="op">(</span>item<span class="op">:</span> T<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    console<span class="op">.</span><span class="fu">putStrLn</span><span class="op">(</span>item<span class="op">.</span>asJson<span class="op">.</span><span class="fu">printWith</span><span class="op">(</span>Printer<span class="op">.</span>spaces2SortKeys<span class="op">))</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>The JSON sink requires <code>Console</code> and then for each element <code>T</code> it converts it to JSON and pretty prints it to console. Note that this is going to be a JSON document per each line. We could easily define a different sink that collects each element and produces a single valid JSON array of them:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> arraySink<span class="op">[</span>T<span class="op">:</span> <span class="ex">Encoder</span><span class="op">]:</span> ZSink<span class="op">[</span><span class="ex">Console</span><span class="op">,</span> Nothing<span class="op">,</span> T<span class="op">,</span> T<span class="op">,</span> <span class="bu">Unit</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    ZSink<span class="op">.</span>collectAll<span class="op">.</span>flatMap <span class="op">{</span> <span class="op">(</span>items<span class="op">:</span> Chunk<span class="op">[</span>T<span class="op">])</span> <span class="op">=&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>      ZSink<span class="op">.</span>fromEffect <span class="op">{</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        console<span class="op">.</span><span class="fu">putStrLn</span><span class="op">(</span>Json<span class="op">.</span><span class="fu">arr</span><span class="op">(</span>items<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>asJson<span class="op">):</span> _<span class="op">*).</span><span class="fu">printWith</span><span class="op">(</span>Printer<span class="op">.</span>spaces2SortKeys<span class="op">))</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>The <code>T</code> type paramter in our example will always be <code>PodInfo</code>. By requiring it to have an implementation of circe’s <code>Encoder</code> type class we can call <code>.asJson</code> on instances of <code>T</code>, encoding it into a JSON object. We can <em>derive</em> these encoders automatically:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">val</span> encoder<span class="op">:</span> <span class="ex">Encoder</span><span class="op">[</span>PodInfo<span class="op">]</span> <span class="op">=</span> deriveEncoder</span></code></pre></div>
<p>Producing YAML output is exactly the same except of first converting the JSON model to YAML with <code>asJson.asYaml</code>.</p>
<p>The third output format option is to generate ASCII tables. We implement that with the same Java library as the original post, called <a href="https://github.com/vdmeer/asciitable"><code>asciitable</code></a>. In order to separate the specification of how to convert a <code>PodInfo</code> to a table from the sink implementation, we can define our own type class similar to the JSON <code>Encoder</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Tabular<span class="op">[</span>T<span class="op">]</span> <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span> Initializes a table by setting properties and adding header rows</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>      <span class="co">*/</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">createTableRenderer</span><span class="op">():</span> ZManaged<span class="op">[</span><span class="ex">Any</span><span class="op">,</span> Nothing<span class="op">,</span> AsciiTable<span class="op">]</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span> Adds a single item of type T to the table created with <span class="co">[[</span>createTableRenderer<span class="co">()]]</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      <span class="co">*/</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">addRow</span><span class="op">(</span>table<span class="op">:</span> AsciiTable<span class="op">)(</span>item<span class="op">:</span> T<span class="op">):</span> UIO<span class="op">[</span><span class="bu">Unit</span><span class="op">]</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span> Adds the table<span class="co">'</span>s footer and renders it to a string</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">*/</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">renderTable</span><span class="op">(</span>table<span class="op">:</span> AsciiTable<span class="op">):</span> UIO<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>We can implement this for <code>PodInfo</code> and then use a generic sink for printing the result table, similar to the previous examples:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sink<span class="op">[</span>T<span class="op">](</span><span class="kw">implicit</span> tabular<span class="op">:</span> Tabular<span class="op">[</span>T<span class="op">]):</span> ZSink<span class="op">[</span><span class="ex">Console</span><span class="op">,</span> Nothing<span class="op">,</span> T<span class="op">,</span> T<span class="op">,</span> <span class="bu">Unit</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  ZSink<span class="op">.</span>managed<span class="op">[</span><span class="ex">Console</span><span class="op">,</span> Nothing<span class="op">,</span> T<span class="op">,</span> AsciiTable<span class="op">,</span> T<span class="op">,</span> <span class="bu">Unit</span><span class="op">](</span>tabular<span class="op">.</span><span class="fu">createTableRenderer</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=&gt;</span> <span class="co">// initialize the table</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>      ZSink<span class="op">.</span><span class="fu">foreach</span><span class="op">(</span>tabular<span class="op">.</span><span class="fu">addRow</span><span class="op">(</span>table<span class="op">))</span> <span class="op">&lt;*</span> <span class="co">// add each row</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      printResultTable<span class="op">[</span>T<span class="op">](</span>table<span class="op">)</span> <span class="co">// print the result</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> printResultTable<span class="op">[</span>T<span class="op">](</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  table<span class="op">:</span> AsciiTable</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="op">)(</span><span class="kw">implicit</span> tabular<span class="op">:</span> Tabular<span class="op">[</span>T<span class="op">]):</span> ZSink<span class="op">[</span><span class="ex">Console</span><span class="op">,</span> Nothing<span class="op">,</span> T<span class="op">,</span> T<span class="op">,</span> <span class="bu">Unit</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  ZSink<span class="op">.</span>fromEffect <span class="op">{</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    tabular</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">renderTable</span><span class="op">(</span>table<span class="op">)</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>str <span class="op">=&gt;</span> console<span class="op">.</span><span class="fu">putStrLn</span><span class="op">(</span>str<span class="op">))</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<h3 id="trying-it-out">Trying it out</h3>
<p>With the report sinks implemenented we have everything ready to try out our new <code>kubectl</code> plugin!</p>
<p>We can compile the example to <em>native image</em> and copy the resulting image to a location on the <code>PATH</code>:</p>
<pre><code>sbt nativeImage
cp target/native-image/kubectl-lp ~/bin</code></pre>
<p>Then use <code>kubectl lp</code> to access our custom functions:</p>
<figure>
<img src="../images/blog-ziok8s-kubectlplugin.png" alt="kubectl-example" />
<figcaption aria-hidden="true">kubectl-example</figcaption>
</figure>


<div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vigoo'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        </div>
        <div id="footer">
            Daniel Vigovszky <a href="https://github.com/vigoo">github.com/vigoo</a>
        </div>
    </body>
    <script type="text/javascript">
      $('.zimg').zoomingBox();
    </script>
</html>
