<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>ScalaFX with FXML</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

        <!-- zoomingbox -->
        <script src="/assets/js/jquery-1.11.0.min.js"></script>
        <script src="/assets/js/jquery.zoomingbox.min.js"></script>
        <link href="/assets/css/zoomingbox.min.css" rel="stylesheet" />
    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">vigoo's software development blog</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>ScalaFX with FXML</h2>
<p class="meta">12 Jan 2014</p>

<div class="post">
<p><a href="https://code.google.com/p/scalafx/">ScalaFX</a> is a nice wrapper around JavaFX for Scala, but currently it lacks support for using <a href="http://docs.oracle.com/javafx/2/api/javafx/fxml/doc-files/introduction_to_fxml.html">FXML</a> instead of Scala code for defining the user interfaces. This can be understood as <em>ScalaFX</em> is in fact a DSL for defining the UI in Scala instead of an XML file. Still I believe that using FXML instead may have its advantages; first of all it has a visual designer (<a href="http://www.oracle.com/technetwork/java/javafx/tools/index.html">JavaFX Scene Builder</a>). For me, designing an UI without immediate visual feedback is hard, and involves a lot of iterations of tweaking the code, running it and checking the results. I also expect that in the future there will be more tools available which work on FXML data.</p>

<p>It is not impossible to use FXML user interfaces from Scala, but the ScalaFX wrappers does not help and the code for the controller classes is not clean enough. See <a href="https://github.com/jpsacha/ProScalaFX/blob/master/src/proscalafx/ch10/fxml/AdoptionFormController.scala">the following example</a> to get a feeling how it looks like.</p>

<p>To make it better I wrote a small library called <a href="https://github.com/vigoo/scalafxml">ScalaFXML</a>. In this post I&#39;ll go through a small example to explain how it works.</p>

<p>The following image shows how our sample application will look like:</p>

<p><img src="/assets/images/unit-conversion-shot.png" alt="unit-conversion-shot"></p>

<p>The <em>From</em> fiels is editable, and the result in the <em>To</em> field is filled as you type using <em>data binding</em>. The <em>Close</em> button&#39;s only purpose is to demonstrate event handlers.</p>

<p>The conversion logic itself is implemented by <a href="https://github.com/vigoo/scalafxml/blob/master/demo/src/main/scala/scalafxml/demo/unitconverter/UnitConverter.scala">small classes</a> sharing the same trait:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">trait</span> <span class="nc">UnitConverter</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span>
  <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">toString</span> <span class="k">=</span> <span class="n">description</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">MMtoInches</span> <span class="k">extends</span> <span class="nc">UnitConverter</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;Millimeters to inches&quot;</span>
  <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> 
      <span class="k">try</span> <span class="o">{</span> 
          <span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="n">toDouble</span> <span class="o">/</span> <span class="mf">25.4</span><span class="o">).</span><span class="n">toString</span> 
      <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span> 
          <span class="k">case</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">Throwable</span> <span class="o">=&gt;</span> <span class="n">ex</span><span class="o">.</span><span class="n">toString</span> 
      <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">InchesToMM</span> <span class="k">extends</span> <span class="nc">UnitConverter</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;Inches to millimeters&quot;</span>
  <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> 
      <span class="k">try</span> <span class="o">{</span> 
          <span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="n">toDouble</span> <span class="o">*</span> <span class="mf">25.4</span><span class="o">).</span><span class="n">toString</span> 
      <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span> 
          <span class="k">case</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">Throwable</span> <span class="o">=&gt;</span> <span class="n">ex</span><span class="o">.</span><span class="n">toString</span> 
      <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>To describe the set of available <em>unit converters</em>, we define one more helper class:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">UnitConverters</span><span class="o">(</span><span class="n">converters</span><span class="k">:</span> <span class="kt">UnitConverter*</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">available</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">converters</span> <span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

<p>Now let&#39;s start with a <a href="https://github.com/vigoo/scalafxml/blob/master/demo/src/main/scala/scalafxml/demo/unitconverter/PureScalaFX.scala">pure ScalaFX solution</a>, where the user interface is defined in Scala. I&#39;ve implemented the view itself in a class called <code>PureScalaFXView</code>, which gets the set of available <em>unit converters</em> as a dependency through its constructor. This makes the main application object very simple:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">PureScalaFX</span> <span class="k">extends</span> <span class="nc">JFXApp</span> <span class="o">{</span>
  <span class="n">stage</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PureScalaFXView</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">UnitConverters</span><span class="o">(</span><span class="nc">InchesToMM</span><span class="o">,</span> <span class="nc">MMtoInches</span><span class="o">))</span>
<span class="o">}</span></code></pre></div>

<p>The <code>PureScalaFXView</code> class consists of two distinct parts. First we define the user interface using the <em>ScalaFX UI DSL</em>:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">PureScalaFXView</span><span class="o">(</span><span class="n">converters</span><span class="k">:</span> <span class="kt">UnitConverters</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">JFXApp</span><span class="o">.</span><span class="nc">PrimaryStage</span> <span class="o">{</span>

  <span class="c1">// UI Definition</span>
  <span class="n">title</span> <span class="k">=</span> <span class="s">&quot;Unit conversion&quot;</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">types</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ComboBox</span><span class="o">[</span><span class="kt">UnitConverter</span><span class="o">]()</span> <span class="o">{</span>
    <span class="n">maxWidth</span> <span class="k">=</span> <span class="nc">Double</span><span class="o">.</span><span class="nc">MaxValue</span>
    <span class="n">margin</span> <span class="k">=</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">from</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TextField</span> <span class="o">{</span>
    <span class="n">margin</span> <span class="k">=</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
    <span class="n">prefWidth</span> <span class="k">=</span> <span class="mf">200.0</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">to</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TextField</span> <span class="o">{</span>
    <span class="n">prefWidth</span> <span class="k">=</span> <span class="mf">200.0</span>
    <span class="n">margin</span> <span class="k">=</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
    <span class="n">editable</span> <span class="k">=</span> <span class="kc">false</span>
  <span class="o">}</span>

  <span class="n">scene</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Scene</span> <span class="o">{</span>
    <span class="n">content</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">GridPane</span> <span class="o">{</span>
      <span class="n">padding</span> <span class="k">=</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>

      <span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Label</span><span class="o">(</span><span class="s">&quot;Conversion type:&quot;</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
      <span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Label</span><span class="o">(</span><span class="s">&quot;From:&quot;</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
      <span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Label</span><span class="o">(</span><span class="s">&quot;To:&quot;</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>

      <span class="n">add</span><span class="o">(</span><span class="n">types</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
      <span class="n">add</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
      <span class="n">add</span><span class="o">(</span><span class="n">to</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>

      <span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Button</span><span class="o">(</span><span class="s">&quot;Close&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// inline event handler binding</span>
        <span class="n">onAction</span> <span class="k">=</span> <span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">ActionEvent</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Platform</span><span class="o">.</span><span class="n">exit</span><span class="o">()</span>
      <span class="o">},</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>

      <span class="n">columnConstraints</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
        <span class="k">new</span> <span class="nc">ColumnConstraints</span> <span class="o">{</span>
          <span class="n">halignment</span> <span class="k">=</span> <span class="nc">HPos</span><span class="o">.</span><span class="nc">LEFT</span>
          <span class="n">hgrow</span> <span class="k">=</span> <span class="nc">Priority</span><span class="o">.</span><span class="nc">SOMETIMES</span>
          <span class="n">margin</span> <span class="k">=</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
        <span class="o">},</span>
        <span class="k">new</span> <span class="nc">ColumnConstraints</span> <span class="o">{</span>
          <span class="n">halignment</span> <span class="k">=</span> <span class="nc">HPos</span><span class="o">.</span><span class="nc">RIGHT</span>
          <span class="n">hgrow</span> <span class="k">=</span> <span class="nc">Priority</span><span class="o">.</span><span class="nc">ALWAYS</span>
          <span class="n">margin</span> <span class="k">=</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre></div>

<p>This is not 100% pure UI definition, because it also contains an inline event handler definition for the <em>Close</em> button.</p>

<p>The next part fills the <em>combo box</em> and defines the data binding. Filling the combo box is a simple procedural loop:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">(</span><span class="n">converter</span> <span class="k">&lt;-</span> <span class="n">converters</span><span class="o">.</span><span class="n">available</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">types</span> <span class="o">+=</span> <span class="n">converter</span>
  <span class="o">}</span>
  <span class="n">types</span><span class="o">.</span><span class="n">getSelectionModel</span><span class="o">.</span><span class="n">selectFirst</span><span class="o">()</span></code></pre></div>

<p>For the data binding we define a <a href="http://docs.oracle.com/javafx/2/binding/jfxpub-binding.htm">low level data binding</a> which depends on the combo box&#39;s selected value and the <em>From</em> field&#39;s text, and produces the output for the <em>To</em> field:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">to</span><span class="o">.</span><span class="n">text</span> <span class="o">&lt;==</span> <span class="k">new</span> <span class="nc">StringBinding</span> <span class="o">{</span>
    <span class="n">bind</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">delegate</span><span class="o">,</span> <span class="n">types</span><span class="o">.</span><span class="n">getSelectionModel</span><span class="o">.</span><span class="n">selectedItemProperty</span><span class="o">)</span>
    <span class="k">def</span> <span class="n">computeValue</span><span class="o">()</span> <span class="k">=</span> <span class="n">types</span><span class="o">.</span><span class="n">getSelectionModel</span><span class="o">.</span><span class="n">getSelectedItem</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
  <span class="o">}</span></code></pre></div>

<p>That&#39;s all, the application is fully functional. The next thing is to split this class so the UI definition and the UI logic got separated. This <a href="https://github.com/vigoo/scalafxml/blob/master/demo/src/main/scala/scalafxml/demo/unitconverter/RefactoredPureScalaFX.scala">refactored ScalaFX solution</a> is very similar to the previous one, but the initialization of the combo box, the data binding and the event handler are all encapsulated by a new, separate class:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">RawUnitConverterPresenter</span><span class="o">(</span>
                              <span class="k">private</span> <span class="k">val</span> <span class="n">from</span><span class="k">:</span> <span class="kt">TextField</span><span class="o">,</span>
                              <span class="k">private</span> <span class="k">val</span> <span class="n">to</span><span class="k">:</span> <span class="kt">TextField</span><span class="o">,</span>
                              <span class="k">private</span> <span class="k">val</span> <span class="n">types</span><span class="k">:</span> <span class="kt">ComboBox</span><span class="o">[</span><span class="kt">UnitConverter</span><span class="o">],</span>
                              <span class="k">private</span> <span class="k">val</span> <span class="n">converters</span><span class="k">:</span> <span class="kt">UnitConverters</span><span class="o">)</span> <span class="o">{</span>

  <span class="c1">// Filling the combo box</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">converter</span> <span class="k">&lt;-</span> <span class="n">converters</span><span class="o">.</span><span class="n">available</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">types</span> <span class="o">+=</span> <span class="n">converter</span>
  <span class="o">}</span>
  <span class="n">types</span><span class="o">.</span><span class="n">getSelectionModel</span><span class="o">.</span><span class="n">selectFirst</span><span class="o">()</span>

  <span class="c1">// Data binding</span>
  <span class="n">to</span><span class="o">.</span><span class="n">text</span> <span class="o">&lt;==</span> <span class="k">new</span> <span class="nc">StringBinding</span> <span class="o">{</span>
    <span class="n">bind</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">delegate</span><span class="o">,</span> <span class="n">types</span><span class="o">.</span><span class="n">getSelectionModel</span><span class="o">.</span><span class="n">selectedItemProperty</span><span class="o">)</span>
    <span class="k">def</span> <span class="n">computeValue</span><span class="o">()</span> <span class="k">=</span> <span class="n">types</span><span class="o">.</span><span class="n">getSelectionModel</span><span class="o">.</span><span class="n">getSelectedItem</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// Close button event handler</span>
  <span class="k">def</span> <span class="n">onClose</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ActionEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Platform</span><span class="o">.</span><span class="n">exit</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
 

<p>What I wanted is to be able to define the controller class exactly like this while building the user interface from FXML. Without <a href="https://github.com/vigoo/scalafxml">ScalaFXML</a> the controller class have some serious limitations:</p>

<ul>
<li>It must implement the <a href="http://docs.oracle.com/javafx/2/api/javafx/fxml/Initializable.html">Initializable</a> interface</li>
<li>It cannot have any constructor arguments</li>
<li>The user interface objects must be variable fields of the class</li>
<li>And they have to have the type of the JavaFX controls, so to be able to use the ScalaFX wrappers, they have to be explicitly wrapped in the <code>initialize</code> method.</li>
</ul>

<p>With <a href="https://github.com/vigoo/scalafxml">ScalaFXML</a> the process is really simple. First we create the FXML, for example with the <a href="http://www.oracle.com/technetwork/java/javafx/tools/index.html">JavaFX Scene Builder</a>:</p>

<p><img src="/assets/images/unit-conversion-scenebuilder.png" alt="unit-conversion-shot"></p>

<p>In the FXML we give the <code>from</code>, <code>to</code>, and <code>types</code> identifiers to our controls using the <code>fx:id</code> attribute, for example:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;TextField</span> <span class="na">fx:id=</span><span class="s">&quot;from&quot;</span> <span class="na">prefWidth=</span><span class="s">&quot;200.0&quot;</span> 
               <span class="na">GridPane.columnIndex=</span><span class="s">&quot;1&quot;</span> 
               <span class="na">GridPane.margin=</span><span class="s">&quot;$x1&quot;</span> 
               <span class="na">GridPane.rowIndex=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span></code></pre></div>

<p>The event handlers can be specified simply by their name:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Button</span> <span class="na">onAction=</span><span class="s">&quot;#onClose&quot;</span> <span class="na">text=</span><span class="s">&quot;Close&quot;</span> 
        <span class="na">mnemonicParsing=</span><span class="s">&quot;false&quot;</span>
        <span class="na">GridPane.columnIndex=</span><span class="s">&quot;1&quot;</span> 
        <span class="na">GridPane.halignment=</span><span class="s">&quot;RIGHT&quot;</span> 
        <span class="na">GridPane.rowIndex=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span></code></pre></div>

<p>and the controller class must be referenced on the root node </p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml">fx:controller=&quot;scalafxml.demo.unitconverter.UnitConverterPresenter&quot;</code></pre></div>

<p>The controller class <a href="https://github.com/vigoo/scalafxml/blob/master/demo/src/main/scala/scalafxml/demo/unitconverter/ScalaFXML.scala">can be exactly the same as the <code>RawUnitConverterPresenter</code></a>, adding an additional <code>@sfxml</code> annotation for it. Everything else is handled by the library, as we will see.</p>

<p>The application object itself looks like this:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">ScalaFXML</span> <span class="k">extends</span> <span class="nc">JFXApp</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">root</span> <span class="k">=</span> <span class="nc">FXMLView</span><span class="o">(</span><span class="n">getClass</span><span class="o">.</span><span class="n">getResource</span><span class="o">(</span><span class="s">&quot;unitconverter.fxml&quot;</span><span class="o">),</span>
    <span class="k">new</span> <span class="nc">DependenciesByType</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span>
      <span class="n">typeOf</span><span class="o">[</span><span class="kt">UnitConverters</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">UnitConverters</span><span class="o">(</span><span class="nc">InchesToMM</span><span class="o">,</span> <span class="nc">MMtoInches</span><span class="o">))))</span>

  <span class="n">stage</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JFXApp</span><span class="o">.</span><span class="nc">PrimaryStage</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">title</span> <span class="k">=</span> <span class="s">&quot;Unit conversion&quot;</span>
    <span class="n">scene</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Scene</span><span class="o">(</span><span class="n">root</span><span class="o">)</span>

  <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Beside giving the URI for the FXML file we also has to provide the <em>additional dependencies</em> of the controller class. This is an easily extensible part of the library, and it already has support for <a href="https://github.com/dickwall/subcut">SubCut</a> and <a href="https://code.google.com/p/google-guice/">Guice</a> as well. Here we are using a simple <em>type-&gt;value</em> mapping instead.</p>

<p>How does this work? What happens behind the scenes?</p>

<p>The <code>@sfxml</code> is a <a href="http://docs.scala-lang.org/overviews/macros/annotations.html">macro annotation</a>. In <em>compile-time</em>, the class definition itself is transformed by the <a href="https://github.com/vigoo/scalafxml/blob/master/core-macros/src/main/scala/scalafxml/core/macros/sfxmlMacro.scala"><code>sfxmlMacro.impl</code> function</a>. </p>

<p>The transformation&#39;s result is a class definition with the source class&#39; name, but with a completely different content. The original class is added as an inner class, always called <code>Controller</code>. In our example, the generated class definition would look like something similar:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">UnitConverterPresenter</span><span class="o">(</span><span class="k">private</span> <span class="k">val</span> <span class="n">dependencyResolver</span><span class="k">:</span> <span class="kt">ControllerDependencyResolver</span><span class="o">)</span>
    <span class="k">extends</span> <span class="n">javafx</span><span class="o">.</span><span class="n">fxml</span><span class="o">.</span><span class="nc">Initializable</span> 
    <span class="k">with</span> <span class="nc">FxmlProxyGenerator</span><span class="o">.</span><span class="nc">ProxyDependencyInjection</span> <span class="o">{</span>
    
    <span class="k">class</span> <span class="nc">Controller</span><span class="o">(</span>
        <span class="k">private</span> <span class="k">val</span> <span class="n">from</span><span class="k">:</span> <span class="kt">TextField</span><span class="o">,</span>
        <span class="k">private</span> <span class="k">val</span> <span class="n">to</span><span class="k">:</span> <span class="kt">TextField</span><span class="o">,</span>
        <span class="k">private</span> <span class="k">val</span> <span class="n">types</span><span class="k">:</span> <span class="kt">ComboBox</span><span class="o">[</span><span class="kt">UnitConverter</span><span class="o">],</span>
        <span class="k">private</span> <span class="k">val</span> <span class="n">converters</span><span class="k">:</span> <span class="kt">UnitConverters</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// …</span>
    <span class="o">}</span>
    
    <span class="k">private</span> <span class="k">var</span> <span class="n">impl</span><span class="k">:</span> <span class="kt">Controller</span> <span class="o">=</span> <span class="kc">null</span>
    
    <span class="c1">// …</span>
<span class="o">}</span></code></pre></div>
 

<p>The class have four distinct parts:</p>

<ol>
<li>Getting the additional dependencies from the <em>dependency resolver</em></li>
<li>Variable fields for binding the JavaFX controls defined in the FXML</li>
<li>Event handler methods</li>
<li>The <code>initializable</code> method&#39;s implementation</li>
</ol>

<p>The first one is simple - for each constructor argument of the controller class which is <em>not</em> a ScalaFX control, we query the <em>dependency resolver</em> to get a value for it. These are performed when the outer, generated class is instantiated and stored through the <code>ProxyDependencyInjection</code> trait.</p>

<p>The variable fields are simple fields for all the ScalaFX constructor arguments of the controller class, but converted to their JavaFX counterpart. For example the generated field for the controller&#39;s <code>from</code> argument will look like this:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nd">@javafx</span><span class="o">.</span><span class="n">fxml</span><span class="o">.</span><span class="nc">FXML</span>
<span class="k">private</span> <span class="k">var</span> <span class="n">from</span><span class="k">:</span> <span class="kt">javafx.scene.control.TextField</span> <span class="o">=</span> <span class="kc">null</span></code></pre></div>

<p>The <em>event handler</em>&#39;s are proxies for all the public methods of the controller, but the ScalaFX event argument types are replaced with JavaFX event argument types and they are wrapped automatically when forwarding the call to the real implementation. For the <code>onClose</code> event handler it would look like the following:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nd">@javafx</span><span class="o">.</span><span class="n">fxml</span><span class="o">.</span><span class="nc">FXML</span> <span class="k">def</span> <span class="n">onClose</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">javafx.event.ActionEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">impl</span><span class="o">.</span><span class="n">onClose</span><span class="o">(</span><span class="k">new</span> <span class="n">scalafx</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="nc">ActionEvent</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
<span class="o">}</span></code></pre></div>

<p>When JavaFX calls the generated controller&#39;s <code>initialize</code> method, the control fields are already set up, and the additional dependencies were already gathered from the dependency resolver so we have all the values required to instantiate the real controller class. For ScalaFX arguments we wrap the JavaFX controls, for the additional dependencies we use the <code>ProxyDependencyInjection</code> trait&#39;s <code>getDependency</code> method:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">initialize</span><span class="o">(</span><span class="n">url</span><span class="k">:</span> <span class="kt">java.net.URL</span><span class="o">,</span> <span class="n">rb</span><span class="k">:</span> <span class="kt">java.util.ResourceBundle</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">impl</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Controller</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">scalafx</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="nc">TextField</span><span class="o">(</span><span class="n">from</span><span class="o">),</span>
        <span class="k">new</span> <span class="n">scalafx</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="nc">TextField</span><span class="o">(</span><span class="n">to</span><span class="o">),</span>        
        <span class="k">new</span> <span class="n">scalafx</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="nc">ComboBox</span><span class="o">[</span><span class="kt">UnitConverter</span><span class="o">](</span><span class="n">types</span><span class="o">),</span>
        <span class="n">getDependencies</span><span class="o">[</span><span class="kt">UnitConverters</span><span class="o">](</span><span class="s">&quot;converters&quot;</span><span class="o">))</span>
<span class="o">}</span></code></pre></div>

<p>That&#39;s all. The final interesting bit is the <code>FXMLView</code> object, which overrides JavaFX&#39;s default controller factory. This is only necessary to be able to pass the given <code>ControllerDependencyResolver</code> to the generated controller&#39;s constructor:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">fxml</span><span class="k">:</span> <span class="kt">URL</span><span class="o">,</span> <span class="n">dependencies</span><span class="k">:</span> <span class="kt">ControllerDependencyResolver</span><span class="o">)</span><span class="k">:</span> <span class="kt">jfxs.Parent</span> <span class="o">=</span>
    <span class="n">jfxf</span><span class="o">.</span><span class="nc">FXMLLoader</span><span class="o">.</span><span class="n">load</span><span class="o">(</span>
      <span class="n">fxml</span><span class="o">,</span> 
      <span class="kc">null</span><span class="o">,</span>
      <span class="k">new</span> <span class="n">jfxf</span><span class="o">.</span><span class="nc">JavaFXBuilderFactory</span><span class="o">(),</span>
      <span class="k">new</span> <span class="n">jfxu</span><span class="o">.</span><span class="nc">Callback</span><span class="o">[</span><span class="kt">Class</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">Object</span><span class="o">]</span> <span class="o">{</span>
        <span class="k">override</span> <span class="k">def</span> <span class="n">call</span><span class="o">(</span><span class="n">cls</span><span class="k">:</span> <span class="kt">Class</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="k">:</span> <span class="kt">Object</span> <span class="o">=</span> 
            <span class="nc">FxmlProxyGenerator</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span> <span class="n">dependencies</span><span class="o">)</span>
      <span class="o">})</span></code></pre></div>

<p><code>FxmlProxyGenerator</code> uses reflection to create a new instance of the generated controller, and pass the dependency resolver as its only constructor argument.</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vigoo'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    


          <div class="footer">
            <div class="contact">
              <p>
                Daniel Vigovszky<br />
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/vigoo">github.com/vigoo</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
    <script type="text/javascript">
      $('.zimg').zoomingBox();
    </script>
</html>
